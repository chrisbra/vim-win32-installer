From edfc32bde1cb56f1e6ebb405f619f79f41fbacd6 Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Sat, 9 Jun 2018 17:43:09 +0200
Subject: [PATCH] Set VIM_TERMINAL variable in the terminal

---
 runtime/doc/terminal.txt |  1 +
 src/os_unix.c            |  2 ++
 src/os_win32.c           | 18 ++++++++++++++++--
 3 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/runtime/doc/terminal.txt b/runtime/doc/terminal.txt
index b3fe52286..0dbd7d7b9 100644
--- a/runtime/doc/terminal.txt
+++ b/runtime/doc/terminal.txt
@@ -376,6 +376,7 @@ Environment variables are used to pass information to the running job:
     COLUMNS		number of columns in the terminal initially
     COLORS		number of colors, 't_Co' (256*256*256 in the GUI)
     VIM_SERVERNAME	v:servername
+    VIM_TERMINAL        v:version
 
 
 MS-Windows ~
diff --git a/src/os_unix.c b/src/os_unix.c
index 1609bb8e2..b385843be 100644
--- a/src/os_unix.c
+++ b/src/os_unix.c
@@ -4189,6 +4189,8 @@ set_child_environment(long rows, long columns, char *term)
     setenv("COLUMNS", (char *)envbuf, 1);
     sprintf((char *)envbuf, "%ld", colors);
     setenv("COLORS", (char *)envbuf, 1);
+    sprintf((char *)envbuf, "%ld",  get_vim_var_nr(VV_VERSION));
+    setenv("VIM_TERMINAL", (char *)envbuf, 1);
 #  ifdef FEAT_CLIENTSERVER
     setenv("VIM_SERVERNAME", serverName == NULL ? "" : (char *)serverName, 1);
 #  endif
diff --git a/src/os_win32.c b/src/os_win32.c
index 602ef8aa2..fd5bda153 100644
--- a/src/os_win32.c
+++ b/src/os_win32.c
@@ -5280,9 +5280,16 @@ win32_build_env(dict_T *env, garray_T *gap, int is_terminal)
     {
 	char_u	*servername = get_vim_var_str(VV_SEND_SERVER);
 	size_t	lval = STRLEN(servername);
-	size_t	n;
+	char_u	*version = get_vim_var_str(VV_VERSION);
+	size_t	lval2 = STRLEN(version);
+	/* initial size of
+	 * VIM_SERVERNAME and value
+	 * VIM_TERMINAL and value
+	 * plus terminating null
+	 */
+	size_t	n = 15 + 13 + 2 + lval + lval2;
 
-	if (ga_grow(gap, (int)(14 + lval + 2)) == OK)
+	if (ga_grow(gap, (int)n) == OK)
 	{
 	    for (n = 0; n < 15; n++)
 		*((WCHAR*)gap->ga_data + gap->ga_len++) =
@@ -5291,6 +5298,13 @@ win32_build_env(dict_T *env, garray_T *gap, int is_terminal)
 		*((WCHAR*)gap->ga_data + gap->ga_len++) =
 		    (WCHAR)servername[n];
 	    *((WCHAR*)gap->ga_data + gap->ga_len++) = L'\0';
+	    for (n = 0; n < 13; n++)
+		*((WCHAR*)gap->ga_data + gap->ga_len++) =
+		    (WCHAR)"VIM_TERMINAL="[n];
+	    for (n = 0; n < lval2; n++)
+		*((WCHAR*)gap->ga_data + gap->ga_len++) =
+		    (WCHAR)version[n];
+	    *((WCHAR*)gap->ga_data + gap->ga_len++) = L'\0';
 	}
     }
 # endif
-- 
2.17.0

